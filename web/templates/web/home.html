{% extends "web/base.html" %}
{% load leaflet_tags %}
{% load crispy_forms_filters %}
{% load crispy_forms_tags %}

{% block content %}
    {#    {% if location or destination %}#}
    {#        <h1>Routes containing "{{ location }}" or "{{ destination }}"</h1>#}
    {#        <h3>#}
    {#            {% with routes.count as total_results %}#}
    {#                Found {{ total_results }} route{{ total_results|pluralize }}#}
    {#            {% endwith %}#}
    {#        </h3>#}
    {#        {% for route in routes %}#}
    {#            <h4><a href="{{ route.get_absolute_url }}">{{ route.name }}</a></h4>#}
    {#{{ post.body|truncatewords:5 }}#}
    {#{% empty %}#}
    {#<p>There are no results for your query.</p>#}
    {#        {% endfor %}#}
    {#        <p><a href="{% url 'home' %}">Search again</a></p>#}
    {#    {% else %}#}
    {#        <h1>Search for routes</h1>#}
    {#        <form action="." method="get">#}
    {#            {{ form|crispy }}#}
    {#            <input type="submit" value="Search" class="btn btn-outline-info">#}
    {#        </form>#}
    {#    {% endif %}#}
    <script type="text/javascript">
        function our_routing(map) {
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            L.Routing.control({
                routeWhileDragging: true,
                geocoder: L.Control.Geocoder.nominatim(),
            }).
            {#on('routingstart', showSpinner)#}
            {#    .on('routesfound routingerror', hideSpinner).#}
            on('routeselected', function (e) {
                let route = e.route;
                console.log(route);
                {#console.log(route.name);#}
                console.log(route.summary.totalDistance)
                console.log(route.inputWaypoints[0].latLng)
                console.log(route.inputWaypoints[1].latLng)
                {#console.log(JSON.stringify(route.inputWaypoints, null, 2))#}
                {#alert('Showing route between waypoints:\n' + JSON.stringify(route.inputWaypoints, null, 2));#}
                $.ajax({
                    type: "POST",
                    url: "/search/",
                    data: {
                        "route": JSON.stringify(route),
                    },
                    success: function () {
                        $('#message').html("<h2>Data submitted</h2>")
                    },
                    failure: function (data) {
                        console.log("failure");
                        console.log(data);
                    },
                });
            }).addTo(map);
        }
    </script>
    <div class="leaflet-container">{% leaflet_map "routers" callback="window.our_routing" %}</div>

    <div class="container mt-5">
        {% if saccos and route %}
            <h2>Saccos on {{ route.name }}</h2>
            {% for sacco in saccos %}
                <p>{{ sacco.name }}</p>
            {% endfor %}
        {% elif route %}
            <h2>Saccos on {{ route.name }}</h2>
            <h2>No saccos found on route.</h2>
        {% else %}
            <h2>Enter location and destination</h2>
        {% endif %}
    </div>
{% endblock %}